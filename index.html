<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>hserus4</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;padding:16px;background:#07121a;color:#e6f3f6;font-family:Arial}
h1{font-size:18px;margin:0}
.controls{display:flex;gap:10px;align-items:center;margin-top:10px}
button{padding:8px 14px;border:none;border-radius:6px;background:#7be3c7;color:#022;cursor:pointer}
button:disabled{opacity:.5}
.small{font-size:13px;color:#9fb6c7}
#bar{height:10px;background:#122;border-radius:6px;overflow:hidden;margin-top:12px}
#fill{height:100%;width:0%;background:linear-gradient(90deg,#7be3c7,#2bd18a);transition:.25s}
table{width:100%;border-collapse:collapse;margin-top:14px;background:#0b2230}
th,td{padding:9px;border-bottom:1px solid #123;text-align:right}
th{cursor:pointer;color:#9fb6c7}
td.symbol{text-align:left;color:#7bdfff;font-weight:bold}
.green{color:#7be3c7}
.red{color:#ff6b6b}
</style>
</head>
<body>

<h1>hserus4</h1>

<div class="controls">
  <button id="refresh">Refresh</button>
  <div id="status" class="small">Idle</div>
</div>

<div id="bar"><div id="fill"></div></div>

<table>
<thead>
<tr>
  <th>Symbol</th>
  <th>Close%</th>
  <th>Vol%</th>
</tr>
</thead>
<tbody id="tbody">
<tr><td colspan="3" class="small">Click Refresh</td></tr>
</tbody>
</table>

<script>
const BASE = 'https://fapi.binance.com';
const BATCH = 5;
const MAX = 250;

const EXCLUDE = new Set([
"BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT","ADAUSDT","DOGEUSDT",
"AVAXUSDT","DOTUSDT","LINKUSDT","LTCUSDT"
]);

const tbody = document.getElementById('tbody');
const fill = document.getElementById('fill');
const status = document.getElementById('status');
const btn = document.getElementById('refresh');

const pct = (a,b)=>((a-b)/b)*100;

async function safeFetch(url){
  try{
    const r = await fetch(url);
    if(!r.ok) return null;
    return r.json();
  }catch{
    return null;
  }
}

/* Get volatile symbols safely */
async function getSymbols(){
  const data = await safeFetch(`${BASE}/premiumIndex`);
  if(!data) return [];

  return data
    .filter(x =>
      x.symbol.endsWith('USDT') &&
      !EXCLUDE.has(x.symbol)
    )
    .slice(0, MAX)
    .map(x => x.symbol);
}

/* ATR(14) */
function calcATR(kl){
  let trs = [];
  for(let i=1;i<kl.length;i++){
    const h = +kl[i][2];
    const l = +kl[i][3];
    const pc = +kl[i-1][4];
    trs.push(Math.max(h-l, Math.abs(h-pc), Math.abs(l-pc)));
  }
  return trs.reduce((a,b)=>a+b,0)/trs.length;
}

async function scanSymbol(symbol){
  const kl = await safeFetch(`${BASE}/klines?symbol=${symbol}&interval=1h&limit=16`);
  if(!kl || kl.length < 16) return null;

  const cur = kl[kl.length-1];
  const prev = kl[kl.length-2];

  const o = +cur[1], h = +cur[2], l = +cur[3], c = +cur[4], v = +cur[5];
  const pv = +prev[5];

  if(v <= pv) return null;

  const atr = calcATR(kl.slice(0,15));
  const range = h - l;

  if(range <= atr) return null;

  return {
    symbol,
    closePct: pct(c,o),
    volPct: pct(v,pv)
  };
}

async function start(){
  btn.disabled = true;
  tbody.innerHTML = '';
  fill.style.width = '0%';
  status.textContent = 'Preparing scanâ€¦';

  const symbols = await getSymbols();
  if(!symbols.length){
    status.textContent = 'No symbols fetched';
    btn.disabled = false;
    return;
  }

  let done = 0;

  for(let i=0;i<symbols.length;i+=BATCH){
    const batch = symbols.slice(i,i+BATCH);
    const res = await Promise.all(batch.map(scanSymbol));

    res.filter(Boolean).forEach(o=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="symbol">${o.symbol}</td>
        <td class="${o.closePct>=0?'green':'red'}">${o.closePct.toFixed(2)}%</td>
        <td>${o.volPct.toFixed(2)}%</td>
      `;
      tbody.appendChild(tr);
    });

    done += batch.length;
    fill.style.width = (done/symbols.length*100)+'%';
    status.textContent = `Scanning ${done}/${symbols.length}`;
    await new Promise(r=>setTimeout(r,120));
  }

  status.textContent = 'Scan complete';
  btn.disabled = false;
}

btn.onclick = start;

/* Sorting */
document.querySelectorAll('th').forEach((th,i)=>{
  th.onclick=()=>{
    const rows=[...tbody.rows];
    const asc=th.asc=!th.asc;
    rows.sort((a,b)=>{
      const x=parseFloat(a.cells[i].innerText)||0;
      const y=parseFloat(b.cells[i].innerText)||0;
      return asc?x-y:y-x;
    });
    rows.forEach(r=>tbody.appendChild(r));
  };
});
</script>
</body>
</html>
