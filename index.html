<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hserus4</title>
    <style>
        :root {
            --bg: #0b0e11;
            --card: #181a20;
            --text: #eaecef;
            --accent: #f0b90b;
            --green: #02c076;
            --red: #f84960;
            --border: #2b3139;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 { font-size: 1.5rem; color: var(--accent); }

        .controls {
            background: var(--card);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        button {
            background-color: var(--accent);
            color: #000;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Progress Bar */
        .progress-wrapper {
            margin-top: 15px;
            background: #2b3139;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: var(--accent);
            transition: width 0.3s ease;
        }

        #status-text {
            font-size: 0.85rem;
            color: #848e9c;
            margin-top: 8px;
            display: block;
        }

        /* Table Styles */
        .table-container {
            background: var(--card);
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        th {
            background: #2b3139;
            padding: 12px 16px;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #848e9c;
            cursor: pointer;
            user-select: none;
        }

        th:hover { color: var(--text); }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .pos { color: var(--green); }
        .neg { color: var(--red); }
        
        .symbol-name { font-weight: 700; color: var(--accent); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>hserus4</h1>
        <button id="refresh-btn">REFRESH</button>
    </div>

    <div class="controls">
        <div class="progress-wrapper">
            <div id="progress-bar"></div>
        </div>
        <span id="status-text">Click refresh to start scanning...</span>
    </div>

    <div class="table-container">
        <table id="scanner-table">
            <thead>
                <tr>
                    <th onclick="sortTable(0, 'string')">Symbol</th>
                    <th onclick="sortTable(1, 'number')">Close %</th>
                    <th onclick="sortTable(2, 'number')">Vol %</th>
                    <th onclick="sortTable(3, 'number')">Prev Vol%</th>
                    <th onclick="sortTable(4, 'number')">Prev Close%</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <tr><td colspan="5" style="text-align:center; padding: 40px; color:#848e9c;">No data loaded.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const API_BASE = "https://fapi.binance.com/fapi/v1";
    const EXCLUDE_LIST = ["BTCUSDT", "ETHUSDT", "SOLUSDT", "BNBUSDT", "XRPUSDT", "ADAUSDT", "DOGEUSDT", "TRXUSDT", "DOTUSDT", "LTCUSDT"];
    const BATCH_SIZE = 5;
    let tableData = [];

    const refreshBtn = document.getElementById('refresh-btn');
    const progressBar = document.getElementById('progress-bar');
    const statusText = document.getElementById('status-text');
    const tableBody = document.getElementById('table-body');

    async function fetchTickers() {
        const response = await fetch(`${API_BASE}/ticker/24hr`);
        const data = await response.json();
        return data
            .filter(item => item.symbol.endsWith("USDT") && !EXCLUDE_LIST.includes(item.symbol))
            .map(item => ({
                symbol: item.symbol,
                volatility: (parseFloat(item.highPrice) - parseFloat(item.lowPrice)) / parseFloat(item.lowPrice)
            }))
            .sort((a, b) => b.volatility - a.volatility)
            .slice(0, 250);
    }

    async function getKlines(symbol) {
        try {
            const response = await fetch(`${API_BASE}/klines?symbol=${symbol}&interval=1h&limit=3`);
            return await response.json();
        } catch (e) { return null; }
    }

    function checkConditions(klines) {
        if (!klines || klines.length < 3) return null;
        
        const pprev = klines[0]; // Prev-Prev
        const prev = klines[1];  // Previous
        const curr = klines[2];  // Current

        // 1. Color check (index 1: open, index 4: close)
        const isCurrGreen = parseFloat(curr[4]) >= parseFloat(curr[1]);
        const isPrevGreen = parseFloat(prev[4]) >= parseFloat(prev[1]);
        if (isCurrGreen !== isPrevGreen) return null;

        // 2. Volume check (index 5: volume)
        const currVol = parseFloat(curr[5]);
        const prevVol = parseFloat(prev[5]);
        const pprevVol = parseFloat(pprev[5]);
        if (!(currVol > prevVol && prevVol > pprevVol)) return null;

        // Calculations
        const currClose = parseFloat(curr[4]);
        const currOpen = parseFloat(curr[1]);
        const prevClose = parseFloat(prev[4]);
        const prevOpen = parseFloat(prev[1]);

        return {
            currCloseChg: ((currClose - currOpen) / currOpen * 100),
            currVolChg: ((currVol - prevVol) / prevVol * 100),
            prevVolChg: ((prevVol - pprevVol) / pprevVol * 100),
            prevCloseChg: ((prevClose - prevOpen) / prevOpen * 100)
        };
    }

    async function startScan() {
        refreshBtn.disabled = true;
        tableData = [];
        progressBar.style.width = "0%";
        statusText.innerText = "Fetching top 250 volatile assets...";
        
        const symbols = await fetchTickers();
        const total = symbols.length;
        
        for (let i = 0; i < total; i += BATCH_SIZE) {
            const batch = symbols.slice(i, i + BATCH_SIZE);
            const results = await Promise.all(batch.map(async (s) => {
                const klines = await getKlines(s.symbol);
                const stats = checkConditions(klines);
                return stats ? { symbol: s.symbol, ...stats } : null;
            }));

            results.forEach(res => { if (res) tableData.push(res); });
            
            const progress = ((i + batch.length) / total) * 100;
            progressBar.style.width = `${progress}%`;
            statusText.innerText = `Scanning ${i + batch.length} / ${total} symbols... Found: ${tableData.length}`;
            renderTable();
        }

        statusText.innerText = `Scan Complete. Found ${tableData.length} symbols matching conditions.`;
        refreshBtn.disabled = false;
    }

    function renderTable() {
        tableBody.innerHTML = tableData.map(row => `
            <tr>
                <td class="symbol-name">${row.symbol}</td>
                <td class="${row.currCloseChg >= 0 ? 'pos' : 'neg'}">${row.currCloseChg.toFixed(2)}%</td>
                <td class="pos">+${row.currVolChg.toFixed(1)}%</td>
                <td class="pos">+${row.prevVolChg.toFixed(1)}%</td>
                <td class="${row.prevCloseChg >= 0 ? 'pos' : 'neg'}">${row.prevCloseChg.toFixed(2)}%</td>
            </tr>
        `).join('') || `<tr><td colspan="5" style="text-align:center; padding: 20px;">Scanning...</td></tr>`;
    }

    let sortOrder = 1;
    function sortTable(columnIndex, type) {
        sortOrder *= -1;
        tableData.sort((a, b) => {
            const keys = ['symbol', 'currCloseChg', 'currVolChg', 'prevVolChg', 'prevCloseChg'];
            const valA = a[keys[columnIndex]];
            const valB = b[keys[columnIndex]];
            
            if (type === 'string') return valA.localeCompare(valB) * sortOrder;
            return (valA - valB) * sortOrder;
        });
        renderTable();
    }

    refreshBtn.addEventListener('click', startScan);
</script>

</body>
</html>
